<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>无人机指挥官 - 联机策略版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background-color: #020617; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        canvas { display: block; }
        #gameCanvas { cursor: grab; }
        #gameCanvas:active { cursor: grabbing; }

        .glass-panel {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(51, 65, 85, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }
        
        .stat-slider {
            -webkit-appearance: none; height: 4px; background: #334155; border-radius: 2px; outline: none;
        }
        .stat-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 14px; height: 14px; background: #3b82f6; border-radius: 50%; cursor: pointer; transition: background 0.2s;
        }
        .stat-slider::-webkit-slider-thumb:hover { background: #60a5fa; }
        .stat-slider:disabled { opacity: 0.5; cursor: not-allowed; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
        .shake-btn { animation: shake 0.3s ease-in-out; }

        /* 排行榜前三名样式 */
        .rank-1 { color: #fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        .rank-2 { color: #94a3b8; text-shadow: 0 0 10px rgba(148, 163, 184, 0.5); }
        .rank-3 { color: #b45309; text-shadow: 0 0 10px rgba(180, 83, 9, 0.5); }
    </style>
</head>
<body class="flex h-screen w-screen relative overflow-hidden">

    <!-- 左侧：编队编辑器 -->
    <div id="editor-panel" class="glass-panel w-[420px] flex-shrink-0 flex flex-col z-30 transition-transform duration-300 absolute left-0 top-0 bottom-0 border-r border-slate-700 shadow-2xl">
        <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-slate-900/80">
            <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-cyan-300 bg-clip-text text-transparent">
                <i class="fas fa-fighter-jet mr-2"></i>无人机指挥官
            </h1>
            <button onclick="togglePanel()" class="text-gray-400 hover:text-white"><i class="fas fa-chevron-left"></i></button>
        </div>
        
        <div class="px-4 py-3 bg-slate-800/80 text-sm flex justify-between items-center border-b border-slate-700 shadow-inner">
            <span class="text-gray-400 font-bold"><i class="fas fa-coins mr-1 text-yellow-500"></i> 战争预算</span>
            <span id="budget-display" class="font-mono text-green-400 text-lg font-bold">0 / 50000</span>
        </div>

        <!-- 分队列表 -->
        <div class="flex-1 overflow-y-auto p-3 space-y-4 scrollbar-hide bg-slate-900/50" id="squad-list">
            <div id="empty-state" class="text-center text-gray-500 mt-10 text-sm">
                <i class="fas fa-box-open text-4xl mb-2 opacity-30"></i>
                <p>暂无分队<br>请点击下方按钮新建设计</p>
            </div>
        </div>

        <!-- 底部操作栏 -->
        <div class="p-4 border-t border-gray-700 bg-slate-900 space-y-3 shadow-[0_-5px_15px_rgba(0,0,0,0.3)]">
            <button onclick="addDraftSquad()" class="w-full py-2 border-2 border-dashed border-gray-600 text-gray-400 rounded hover:border-blue-500 hover:text-blue-400 hover:bg-slate-800 transition text-sm font-bold">
                <i class="fas fa-plus-circle mr-1"></i> 新建战机设计草稿
            </button>
            
            <div class="grid grid-cols-2 gap-2 pt-2">
                <input type="text" id="fleet-name" placeholder="为你的舰队命名" class="bg-gray-800 border border-gray-600 rounded px-3 py-2 text-sm focus:border-blue-500 outline-none col-span-2 text-white placeholder-gray-500">
                <button id="btn-upload" onclick="saveAndUploadFleet()" class="bg-blue-700 hover:bg-blue-600 text-white py-2 rounded font-bold transition flex items-center justify-center gap-2 text-xs">
                    <i class="fas fa-cloud-upload-alt"></i> 上传云端
                </button>
                <button onclick="toggleLeaderboard()" class="bg-purple-700 hover:bg-purple-600 text-white py-2 rounded font-bold transition flex items-center justify-center gap-2 text-xs">
                    <i class="fas fa-globe"></i> 挑战玩家
                </button>
            </div>
            <button id="btn-start-sim" onclick="startBattle()" class="w-full bg-gradient-to-r from-green-700 to-green-600 hover:from-green-600 hover:to-green-500 text-white py-3 rounded-lg font-bold text-lg shadow-lg shadow-green-900/40 transition transform active:scale-95">
                <i class="fas fa-play mr-2"></i> 开始模拟战
            </button>
        </div>
    </div>

    <button id="panel-opener" onclick="togglePanel()" class="absolute left-4 top-4 z-20 glass-panel p-2 rounded text-blue-400 hidden hover:text-white transition">
        <i class="fas fa-bars text-xl"></i>
    </button>

    <div id="hp-panel" class="absolute top-4 left-1/2 transform -translate-x-1/2 z-20 w-[800px] max-w-[95vw] glass-panel rounded-lg overflow-hidden flex flex-col transition-all duration-300 shadow-xl border-t border-white/10">
        <div class="flex justify-between items-center px-4 py-1 bg-slate-900/80 cursor-pointer" onclick="toggleHpPanel()">
            <span class="text-xs font-bold text-blue-400 flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_5px_#3b82f6]"></div> 我方状态</span>
            <span class="text-[10px] text-gray-500 font-mono">UNIT STATUS MONITOR</span>
            <span class="text-xs font-bold text-red-400 flex items-center gap-2">敌方状态 <div class="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_5px_#ef4444]"></div></span>
        </div>
        <div class="bg-gray-900/90 h-10 w-full relative">
            <canvas id="hpCanvas" class="w-full h-full block"></canvas>
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div class="w-[1px] h-full bg-gray-700"></div>
            </div>
        </div>
    </div>

    <div class="flex-1 relative overflow-hidden bg-[#050b14] w-full h-full">
        <canvas id="gameCanvas" class="w-full h-full block"></canvas>
        
        <div class="absolute top-24 right-4 flex flex-col gap-2 pointer-events-none items-end">
            <div class="glass-panel px-3 py-2 rounded-l-lg border-r-4 border-red-500 text-sm shadow-lg backdrop-blur-md">
                <span class="text-gray-400 text-xs block mb-1">ENEMY FORCE</span>
                <span id="hud-enemy-count" class="text-2xl font-mono font-bold text-red-400">0</span> <span class="text-xs text-red-700">UNIT</span>
            </div>
            <div class="glass-panel px-3 py-2 rounded-l-lg border-r-4 border-blue-500 text-sm shadow-lg backdrop-blur-md mt-2">
                <span class="text-gray-400 text-xs block mb-1">ALLIED FORCE</span>
                <span id="hud-player-count" class="text-2xl font-mono font-bold text-blue-400">0</span> <span class="text-xs text-blue-700">UNIT</span>
            </div>
        </div>

        <div class="absolute bottom-4 right-4 text-xs text-gray-600 pointer-events-none select-none font-mono">
             [LMB] 移动视角  [SCROLL] 缩放  [R] 重置
        </div>
    </div>

    <!-- 排行榜模态框 -->
    <div id="leaderboard-modal" class="hidden absolute inset-0 z-50 bg-black/80 backdrop-blur-sm flex justify-center items-center">
        <div class="glass-panel w-[600px] max-h-[80vh] flex flex-col rounded-xl shadow-2xl border border-purple-500/30">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-purple-900/20">
                <h2 class="text-xl font-bold text-purple-300">全球战术排行榜</h2>
                <button onclick="toggleLeaderboard()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- 搜索框 -->
            <div class="p-3 bg-gray-900/80 border-b border-gray-700">
                <div class="flex gap-2">
                    <input type="text" id="lb-search" placeholder="搜索舰队名称..." class="flex-1 bg-gray-800 border border-gray-600 rounded px-3 py-1 text-sm text-white focus:border-purple-500 outline-none" onkeypress="if(event.key==='Enter') fetchLeaderboard()">
                    <button onclick="fetchLeaderboard()" class="bg-purple-700 hover:bg-purple-600 text-white px-3 py-1 rounded text-sm transition">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            <div class="p-2 bg-gray-800/50 text-xs text-gray-400 flex justify-between px-4 font-mono border-b border-gray-700">
                <span class="w-[10%] text-center">RANK</span>
                <span class="w-[45%]">FLEET INFO</span>
                <span class="w-[25%] text-center">WINS / LOSSES</span>
                <span class="w-[20%] text-right">ACTION</span>
            </div>
            <div id="leaderboard-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                <!-- 列表项 -->
            </div>
        </div>
    </div>

    <div id="result-modal" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-md">
        <div class="glass-panel p-8 rounded-2xl border border-gray-600 text-center shadow-[0_0_50px_rgba(0,0,0,0.5)] transform scale-100 transition-all max-w-md w-full">
            <h2 id="result-title" class="text-5xl font-black mb-2 uppercase italic tracking-wider text-white">VICTORY</h2>
            <p class="text-gray-400 text-sm mb-6 font-mono">TARGET: <span class="text-purple-400 font-bold" id="result-enemy-name">Unknown</span></p>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-800/80 p-3 rounded border border-gray-700">
                    <div class="text-xs text-gray-500">DURATION</div>
                    <div class="text-xl font-mono text-white" id="result-time">0s</div>
                </div>
                <div class="bg-gray-800/80 p-3 rounded border border-gray-700">
                    <div class="text-xs text-gray-500">SURVIVORS</div>
                    <div class="text-xl font-mono text-blue-400" id="result-survivors">0</div>
                </div>
            </div>

            <button onclick="closeResult()" class="w-full bg-white text-black py-3 rounded font-bold hover:bg-gray-200 transition shadow-lg uppercase tracking-widest text-sm">
                Return to Base
            </button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://wyijoirdaxsgckfbriwq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_gaqS_47tgBj0wfZicVWLnA_HQ--nSmk'; 
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const hpCanvas = document.getElementById('hpCanvas');
        const hpCtx = hpCanvas.getContext('2d');

        const WORLD_WIDTH = 3000;
        const WORLD_HEIGHT = 2000;
        const BUDGET_LIMIT = 50000;
        
        const camera = { x: 0, y: 0, zoom: 0.6 };
        let isDragging = false;
        let lastMousePos = { x: 0, y: 0 };

        let isSimulating = false;
        let isReadyPhase = false;
        let animationId;
        let startTime;
        let drones = [];
        let bullets = [];
        let particles = [];
        let activeEnemyFleetId = null;
        let activeEnemyName = "Unknown";
        let cachedEnemyConfig = null;
        let playerSquads = []; 

        class SpatialHash {
            constructor(cellSize) {
                this.cellSize = cellSize;
                this.grid = new Map();
            }
            key(x, y) { return `${Math.floor(x/this.cellSize)},${Math.floor(y/this.cellSize)}`; }
            clear() { this.grid.clear(); }
            add(client) {
                const k = this.key(client.pos.x, client.pos.y);
                if (!this.grid.has(k)) this.grid.set(k, []);
                this.grid.get(k).push(client);
            }
            query(pos, radius) {
                const clients = [];
                const range = Math.ceil(radius / this.cellSize);
                const cx = Math.floor(pos.x / this.cellSize);
                const cy = Math.floor(pos.y / this.cellSize);
                for (let x = cx - range; x <= cx + range; x++) {
                    for (let y = cy - range; y <= cy + range; y++) {
                        const k = `${x},${y}`;
                        if (this.grid.has(k)) clients.push(...this.grid.get(k));
                    }
                }
                return clients;
            }
        }
        const spatialGrid = new SpatialHash(120);

        class Vector {
            constructor(x, y) { this.x = x; this.y = y; }
            add(v) { this.x += v.x; this.y += v.y; return this; }
            sub(v) { this.x -= v.x; this.y -= v.y; return this; }
            mult(n) { this.x *= n; this.y *= n; return this; }
            div(n) { this.x /= n; this.y /= n; return this; }
            mag() { return Math.sqrt(this.x*this.x + this.y*this.y); }
            normalize() { let m = this.mag(); if(m!==0) this.div(m); return this; }
            limit(max) { if(this.mag()>max){ this.normalize(); this.mult(max); } return this; }
            static dist(v1, v2) { return Math.sqrt((v1.x-v2.x)**2 + (v1.y-v2.y)**2); }
            static sub(v1, v2) { return new Vector(v1.x-v2.x, v1.y-v2.y); }
        }

        class Drone {
            constructor(team, config, x, y) {
                this.team = team; 
                this.pos = new Vector(x, y);
                this.vel = new Vector(Math.random()-0.5, Math.random()-0.5);
                this.acc = new Vector(0, 0);
                this.maxHp = config.hp;
                this.hp = this.maxHp;
                this.maxSpeed = config.speed;
                this.maxForce = config.agility; 
                this.damage = config.dmg;
                this.range = config.range;
                this.shape = config.shape; 
                this.baseColor = config.color;
                this.radius = 6 + (this.maxHp / 150); 
                this.reloadTime = 600 / config.speed; 
                this.cooldown = Math.random() * this.reloadTime;
            }

            applyForce(force) { this.acc.add(force); }

            flock(friends, enemies, grid) {
                if (!isSimulating) return;
                
                let sep = new Vector(0,0), ali = new Vector(0,0), coh = new Vector(0,0);
                let sepCount = 0, aliCount = 0, cohCount = 0;
                
                let neighbors = grid.query(this.pos, 80); 

                for (let other of neighbors) {
                    if (other === this || other.team !== this.team) continue;
                    let d = Vector.dist(this.pos, other.pos);
                    if (d < 25) { 
                        let diff = Vector.sub(this.pos, other.pos).normalize().div(d);
                        sep.add(diff); sepCount++;
                    }
                    if (d < 60) {
                        ali.add(other.vel); coh.add(other.pos);
                        aliCount++; cohCount++;
                    }
                }

                if (sepCount > 0) sep.div(sepCount).normalize().mult(this.maxSpeed).sub(this.vel).limit(this.maxForce * 2.5);
                if (aliCount > 0) ali.div(aliCount).normalize().mult(this.maxSpeed).sub(this.vel).limit(this.maxForce);
                if (cohCount > 0) coh.div(cohCount).sub(this.pos).normalize().mult(this.maxSpeed).sub(this.vel).limit(this.maxForce * 0.5);

                this.applyForce(sep);
                this.applyForce(ali);
                this.applyForce(coh);

                let target = this.findTarget(enemies);
                if (target) {
                    let d = Vector.dist(this.pos, target.pos);
                    if (d < this.range * 0.8 && d < 100) {
                        let retreat = Vector.sub(this.pos, target.pos).normalize().mult(this.maxSpeed);
                        this.applyForce(Vector.sub(retreat, this.vel).limit(this.maxForce * 1.5));
                    } else {
                        let approach = Vector.sub(target.pos, this.pos).normalize().mult(this.maxSpeed);
                        this.applyForce(Vector.sub(approach, this.vel).limit(this.maxForce));
                    }
                    if (d < this.range) this.attack(target);
                }
                this.boundaries();
            }

            findTarget(enemies) {
                let minD = Infinity;
                let target = null;
                for(let e of enemies) {
                    let d = Vector.dist(this.pos, e.pos);
                    if (d < minD) { minD = d; target = e; }
                }
                return target;
            }

            attack(target) {
                if (this.cooldown <= 0) {
                    bullets.push(new Bullet(this.pos.x, this.pos.y, target, this.baseColor, this.damage, this.team));
                    this.cooldown = this.reloadTime;
                    particles.push(new Particle(this.pos.x, this.pos.y, this.baseColor, 5, 0.5));
                }
                this.cooldown--;
            }

            boundaries() {
                let bounced = false;
                if (this.pos.x < 10) { this.pos.x = 10; this.vel.x *= -1; bounced = true; }
                if (this.pos.x > WORLD_WIDTH-10) { this.pos.x = WORLD_WIDTH-10; this.vel.x *= -1; bounced = true; }
                if (this.pos.y < 10) { this.pos.y = 10; this.vel.y *= -1; bounced = true; }
                if (this.pos.y > WORLD_HEIGHT-10) { this.pos.y = WORLD_HEIGHT-10; this.vel.y *= -1; bounced = true; }

                if (!bounced) {
                    const margin = 150;
                    let desired = null;
                    if (this.pos.x < margin) desired = new Vector(this.maxSpeed, this.vel.y);
                    else if (this.pos.x > WORLD_WIDTH - margin) desired = new Vector(-this.maxSpeed, this.vel.y);
                    if (this.pos.y < margin) desired = new Vector(this.vel.x, this.maxSpeed);
                    else if (this.pos.y > WORLD_HEIGHT - margin) desired = new Vector(this.vel.x, -this.maxSpeed);

                    if (desired) {
                        desired.normalize().mult(this.maxSpeed);
                        this.applyForce(Vector.sub(desired, this.vel).limit(this.maxForce * 1.5));
                    }
                }
            }

            update() {
                if (!isSimulating) return;
                this.vel.add(this.acc);
                this.vel.limit(this.maxSpeed);
                this.pos.add(this.vel);
                this.acc.mult(0);
                this.pos.x = Math.max(0, Math.min(this.pos.x, WORLD_WIDTH));
                this.pos.y = Math.max(0, Math.min(this.pos.y, WORLD_HEIGHT));
            }

            draw(ctx) {
                ctx.save();
                ctx.translate(this.pos.x, this.pos.y);
                ctx.rotate(Math.atan2(this.vel.y, this.vel.x));
                ctx.fillStyle = this.baseColor;
                
                ctx.beginPath();
                if (this.shape === 'triangle') {
                    ctx.moveTo(this.radius * 1.5, 0);
                    ctx.lineTo(-this.radius, this.radius);
                    ctx.lineTo(-this.radius, -this.radius);
                } else if (this.shape === 'square') {
                    ctx.rect(-this.radius, -this.radius, this.radius*2, this.radius*2);
                } else if (this.shape === 'circle') {
                    ctx.arc(0, 0, this.radius, 0, Math.PI*2);
                } else if (this.shape === 'diamond') {
                    ctx.moveTo(this.radius * 1.5, 0);
                    ctx.lineTo(0, this.radius);
                    ctx.lineTo(-this.radius * 1.5, 0);
                    ctx.lineTo(0, -this.radius);
                }
                ctx.fill();
                
                if (this.team === 'blue') {
                    ctx.strokeStyle = 'rgba(96, 165, 250, 0.8)';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
                ctx.restore();
            }
        }

        class Bullet {
            constructor(x, y, target, color, dmg, team) {
                this.pos = new Vector(x, y);
                this.speed = 20;
                this.damage = dmg;
                this.color = color;
                this.team = team; 
                this.life = 100;
                let dir = Vector.sub(target.pos, this.pos).normalize().mult(this.speed);
                dir.x += (Math.random()-0.5) * 0.3; 
                dir.y += (Math.random()-0.5) * 0.3;
                this.vel = dir;
            }
            update() { this.pos.add(this.vel); this.life--; }
            draw(ctx) {
                ctx.fillStyle = this.color;
                ctx.globalAlpha = this.life / 80;
                ctx.beginPath(); ctx.arc(this.pos.x, this.pos.y, 3, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        class Particle {
            constructor(x, y, color, life, speed) {
                this.pos = new Vector(x, y);
                let angle = Math.random() * Math.PI * 2;
                let sp = Math.random() * speed;
                this.vel = new Vector(Math.cos(angle)*sp, Math.sin(angle)*sp);
                this.color = color; this.life = life; this.maxLife = life; this.size = Math.random()*3+1;
            }
            update() { this.pos.add(this.vel); this.life--; this.vel.mult(0.95); }
            draw(ctx) {
                ctx.globalAlpha = this.life / this.maxLife; ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(this.pos.x, this.pos.y, this.size, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        function togglePanel() {
            const panel = document.getElementById('editor-panel');
            const opener = document.getElementById('panel-opener');
            if (panel.classList.contains('-translate-x-full')) {
                panel.classList.remove('-translate-x-full');
                opener.classList.add('hidden');
            } else {
                panel.classList.add('-translate-x-full');
                opener.classList.remove('hidden');
            }
        }
        
        function toggleHpPanel() {
            const panel = document.getElementById('hp-panel');
            panel.classList.toggle('opacity-50');
            panel.classList.toggle('scale-90');
        }

        function calculateCost(squad) {
            let unitCost = (squad.hp * 0.5) + (squad.dmg * 2) + (squad.speed * 5) + (squad.agility * 200) + (squad.range * 0.1);
            return Math.floor(unitCost * squad.count);
        }

        function getUsedBudget() {
            return playerSquads.filter(s => s.status === 'deployed').reduce((acc, s) => acc + calculateCost(s), 0);
        }

        function updateBudgetDisplay() {
            const used = getUsedBudget();
            const el = document.getElementById('budget-display');
            el.innerText = `${used} / ${BUDGET_LIMIT}`;
            el.className = `font-mono text-lg font-bold ${used > BUDGET_LIMIT ? 'text-red-500' : 'text-green-400'}`;
        }

        function renderSquadList() {
            const container = document.getElementById('squad-list');
            container.innerHTML = '';
            
            if (playerSquads.length === 0) {
                 container.innerHTML = `<div id="empty-state" class="text-center text-gray-500 mt-10 text-sm">
                <i class="fas fa-box-open text-4xl mb-2 opacity-30"></i>
                <p>暂无分队<br>请点击下方按钮新建设计</p>
            </div>`;
            }

            const usedBudget = getUsedBudget();
            
            playerSquads.forEach((squad, idx) => {
                const cost = calculateCost(squad);
                const isDraft = squad.status === 'draft';
                const canAfford = (usedBudget + cost) <= BUDGET_LIMIT || !isDraft;

                const el = document.createElement('div');
                el.className = isDraft 
                    ? 'bg-slate-800 p-3 rounded border-2 border-dashed border-yellow-600/50 relative group transition'
                    : 'bg-slate-800/80 p-3 rounded border border-gray-700 relative group transition hover:border-blue-500/50';
                
                const disabledAttr = isDraft ? '' : 'disabled';
                const opacityClass = isDraft ? '' : 'opacity-75';

                let actionButton = '';
                if (isDraft) {
                    const btnClass = canAfford 
                        ? 'bg-green-600 hover:bg-green-500 text-white shadow-lg shadow-green-900/50' 
                        : 'bg-gray-700 text-gray-400 cursor-not-allowed';
                    const btnText = canAfford ? '<i class="fas fa-check"></i> 确认部署' : '资金不足';
                    const onClick = canAfford ? `confirmSquad(${idx})` : '';
                    actionButton = `
                        <button onclick="${onClick}" class="w-full mt-3 py-2 rounded font-bold text-xs transition ${btnClass}">
                            ${btnText}
                        </button>
                    `;
                }

                el.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-2 w-full">
                            <span class="text-xs ${isDraft ? 'text-yellow-500' : 'text-blue-400'} font-bold px-1.5 py-0.5 rounded bg-black/30">
                                ${isDraft ? 'DRAFT' : 'ACTIVE'}
                            </span>
                            <input value="${squad.name}" ${disabledAttr} onchange="updateSquadData(${idx}, 'name', this.value)" class="bg-transparent font-bold text-gray-200 text-sm w-full outline-none border-b border-transparent focus:border-blue-500 transition placeholder-gray-600">
                        </div>
                        <button onclick="removeSquad(${idx})" class="text-gray-600 hover:text-red-400 transition ml-2"><i class="fas fa-trash"></i></button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-xs ${opacityClass}">
                        <div class="col-span-2 flex justify-between items-center bg-black/20 px-2 py-1 rounded">
                            <span class="text-gray-400">分队造价</span>
                            <span class="font-mono text-yellow-500 font-bold">$${cost}</span>
                        </div>
                        <div>
                            <label class="text-gray-500 flex justify-between">数量: <span class="text-white" id="disp-count-${idx}">${squad.count}</span></label>
                            <input type="range" class="stat-slider w-full" min="1" max="100" value="${squad.count}" ${disabledAttr}
                                oninput="updateSquadData(${idx}, 'count', this.value, true)">
                        </div>
                        <div>
                            <label class="text-gray-500 flex justify-between">血量: <span class="text-white" id="disp-hp-${idx}">${squad.hp}</span></label>
                            <input type="range" class="stat-slider w-full" min="10" max="500" value="${squad.hp}" ${disabledAttr}
                                oninput="updateSquadData(${idx}, 'hp', this.value, true)">
                        </div>
                        <div>
                            <label class="text-gray-500 flex justify-between">伤害: <span class="text-white" id="disp-dmg-${idx}">${squad.dmg}</span></label>
                            <input type="range" class="stat-slider w-full" min="1" max="50" value="${squad.dmg}" ${disabledAttr}
                                oninput="updateSquadData(${idx}, 'dmg', this.value, true)">
                        </div>
                        <div>
                            <label class="text-gray-500 flex justify-between">射程: <span class="text-white" id="disp-range-${idx}">${squad.range}</span></label>
                            <input type="range" class="stat-slider w-full" min="50" max="400" value="${squad.range}" ${disabledAttr}
                                oninput="updateSquadData(${idx}, 'range', this.value, true)">
                        </div>
                        <div>
                            <label class="text-gray-500 flex justify-between">速度: <span class="text-white" id="disp-speed-${idx}">${squad.speed}</span></label>
                            <input type="range" class="stat-slider w-full" min="1" max="12" step="0.5" value="${squad.speed}" ${disabledAttr}
                                oninput="updateSquadData(${idx}, 'speed', this.value, true)">
                        </div>
                        <div>
                            <label class="text-gray-500 flex justify-between">灵活: <span class="text-white" id="disp-agility-${idx}">${squad.agility}</span></label>
                            <input type="range" class="stat-slider w-full" min="0.05" max="1.0" step="0.05" value="${squad.agility}" ${disabledAttr}
                                oninput="updateSquadData(${idx}, 'agility', this.value, true)">
                        </div>
                    </div>
                    
                    <div class="mt-3 flex gap-2 items-center ${opacityClass}">
                        <label class="text-xs text-gray-500">外观:</label>
                        <select onchange="updateSquadData(${idx}, 'shape', this.value)" ${disabledAttr} class="bg-gray-900 text-xs rounded border border-gray-600 p-1 text-gray-300">
                            <option value="triangle" ${squad.shape==='triangle'?'selected':''}>三角 (高速)</option>
                            <option value="circle" ${squad.shape==='circle'?'selected':''}>圆形 (通用)</option>
                            <option value="square" ${squad.shape==='square'?'selected':''}>方形 (肉盾)</option>
                            <option value="diamond" ${squad.shape==='diamond'?'selected':''}>菱形 (特种)</option>
                        </select>
                        <input type="color" value="${squad.color}" ${disabledAttr} onchange="updateSquadData(${idx}, 'color', this.value)" class="h-6 w-6 rounded bg-transparent border-0 cursor-pointer">
                    </div>
                    ${actionButton}
                `;
                container.appendChild(el);
            });
            updateBudgetDisplay();
        }

        function addDraftSquad() {
            playerSquads.push({ id: Date.now(), name: '新型号原型机', shape: 'triangle', color: '#ffffff', count: 20, hp: 50, dmg: 5, speed: 4, agility: 0.15, range: 120, status: 'draft' });
            renderSquadList();
            const container = document.getElementById('squad-list');
            setTimeout(() => container.scrollTop = container.scrollHeight, 50);
        }

        function confirmSquad(idx) {
            playerSquads[idx].status = 'deployed';
            renderSquadList();
            if (!isSimulating) renderPreview();
        }

        function removeSquad(idx) {
            playerSquads.splice(idx, 1);
            renderSquadList();
            if (!isSimulating) renderPreview();
        }

        function renderPreview() {
            setupScene(cachedEnemyConfig);
        }

        function updateSquadData(idx, field, val, isSlider = false) {
            if (['count','hp','dmg','range'].includes(field)) val = parseInt(val);
            if (['speed','agility'].includes(field)) val = parseFloat(val);
            playerSquads[idx][field] = val;
            if (isSlider) {
                document.getElementById(`disp-${field}-${idx}`).innerText = val;
                renderSquadList(); 
            } else {
                renderSquadList();
            }
        }

        async function saveAndUploadFleet() {
            const btn = document.getElementById('btn-upload');
            const originalText = btn.innerHTML;
            
            try {
                const activeSquads = playerSquads.filter(s => s.status === 'deployed');
                if (activeSquads.length === 0) return alert("请先确认部署至少一个分队！");
                
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 上传中...';
                
                const name = document.getElementById('fleet-name').value || "无名舰队";
                const author = localStorage.getItem('commander_id') || `Cmdr_${Math.floor(Math.random()*10000)}`;
                localStorage.setItem('commander_id', author);

                const { data, error } = await supabaseClient
                    .from('drone_fleets')
                    .insert([{ name: name, author: author, composition: activeSquads }]);

                if (error) throw error;
                
                // 成功反馈
                btn.className = "bg-green-600 text-white py-2 rounded font-bold flex items-center justify-center gap-2 text-xs shake-btn";
                btn.innerHTML = '<i class="fas fa-check"></i> 上传成功';
                setTimeout(() => {
                    btn.className = "bg-blue-700 hover:bg-blue-600 text-white py-2 rounded font-bold transition flex items-center justify-center gap-2 text-xs";
                    btn.innerHTML = originalText;
                }, 2000);
                
            } catch (err) {
                console.error("Upload Error:", err);
                btn.innerHTML = originalText;
                alert("上传失败 (可能是网络或权限问题): " + err.message);
            }
        }

        function toggleLeaderboard() {
            const modal = document.getElementById('leaderboard-modal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                fetchLeaderboard();
            }
        }

        async function fetchLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            const searchInput = document.getElementById('lb-search');
            const searchTerm = searchInput ? searchInput.value.trim() : '';
            
            list.innerHTML = '<div class="text-center text-gray-400 mt-4"><i class="fas fa-spinner fa-spin"></i> 连接战术网络...</div>';
            
            try {
                let query = supabaseClient
                    .from('drone_fleets')
                    .select('*')
                    .order('wins', { ascending: false })
                    .limit(50); // 增加上限

                if (searchTerm) {
                    query = query.ilike('name', `%${searchTerm}%`);
                }

                const { data, error } = await query;

                if (error) throw error;

                if (!data || data.length === 0) {
                    list.innerHTML = '<div class="text-center text-gray-500 mt-4 text-xs">未找到符合条件的舰队</div>';
                    return;
                }

                list.innerHTML = '';
                data.forEach((fleet, index) => {
                    // 计算排名样式
                    let rankClass = "text-gray-500 font-bold";
                    let rankIcon = `#${index + 1}`;
                    
                    if (index === 0) { rankClass = "rank-1 text-base"; rankIcon = '<i class="fas fa-trophy"></i>'; }
                    else if (index === 1) { rankClass = "rank-2 text-base"; rankIcon = '<i class="fas fa-medal"></i>'; }
                    else if (index === 2) { rankClass = "rank-3 text-base"; rankIcon = '<i class="fas fa-medal"></i>'; }

                    const el = document.createElement('div');
                    el.className = 'bg-gray-800 p-2 rounded flex justify-between items-center hover:bg-gray-700 transition border border-gray-700 text-xs';
                    el.innerHTML = `
                        <div class="w-[10%] text-center ${rankClass}">${rankIcon}</div>
                        <div class="w-[45%]">
                            <div class="font-bold text-blue-300 truncate">${fleet.name}</div>
                            <div class="text-gray-500 truncate text-[10px]">${fleet.author}</div>
                        </div>
                        <div class="w-[25%] text-center font-mono">
                            <span class="text-green-400">${fleet.wins}W</span> <span class="text-gray-600">/</span> <span class="text-red-400">${fleet.losses}L</span>
                        </div>
                        <div class="w-[20%] text-right">
                            <button onclick='prepareChallenge(${JSON.stringify(fleet)})' class="bg-red-900/50 hover:bg-red-600 text-red-200 px-2 py-1 rounded border border-red-700 transition font-bold text-[10px]">
                                ENGAGE
                            </button>
                        </div>
                    `;
                    list.appendChild(el);
                });
            } catch (err) {
                console.error("Leaderboard Error:", err);
                list.innerHTML = `<div class="text-red-500 text-center text-xs p-4">
                    连接指挥部失败<br>
                    <span class="opacity-50 text-[10px]">${err.message}</span>
                </div>`;
            }
        }

        function prepareChallenge(fleetData) {
            cachedEnemyConfig = fleetData.composition;
            activeEnemyFleetId = fleetData.id;
            activeEnemyName = fleetData.name;
            document.getElementById('leaderboard-modal').classList.add('hidden');
            setupScene(cachedEnemyConfig);
            isSimulating = false;
            isReadyPhase = true;
            
            const btn = document.getElementById('btn-start-sim');
            btn.innerHTML = '<i class="fas fa-bolt mr-2 animate-pulse"></i> 部署完毕 - 点击开战';
            btn.className = "w-full bg-yellow-600 hover:bg-yellow-500 text-white py-3 rounded-lg font-bold text-lg shadow-lg shadow-yellow-900/50 transition animate-pulse";
        }

        function setupScene(enemyConfig) {
            drones = [];
            bullets = [];
            particles = [];
            spatialGrid.clear();

            const deployedSquads = playerSquads.filter(s => s.status === 'deployed');
            
            deployedSquads.forEach(squad => {
                for(let i=0; i<squad.count; i++) {
                    let x = Math.random() * 400 + 100;
                    let y = Math.random() * (WORLD_HEIGHT - 200) + 100;
                    drones.push(new Drone('blue', squad, x, y));
                }
            });

            if (enemyConfig) {
                enemyConfig.forEach(squad => {
                    let conf = {...squad, color: '#ef4444'}; 
                    for(let i=0; i<squad.count; i++) {
                        let x = WORLD_WIDTH - (Math.random() * 400 + 100);
                        let y = Math.random() * (WORLD_HEIGHT - 200) + 100;
                        drones.push(new Drone('red', conf, x, y));
                    }
                });
            }

            camera.x = WORLD_WIDTH/2 - canvas.width/2;
            camera.y = WORLD_HEIGHT/2 - canvas.height/2;
            camera.zoom = 0.6;
            
            if (!animationId) loop();
        }

        function startBattle() {
            if (playerSquads.filter(s => s.status === 'deployed').length === 0) return alert("请先部署至少一个分队再开始战斗！");
            
            const btn = document.getElementById('btn-start-sim');
            btn.innerHTML = '<i class="fas fa-stop mr-2"></i> 中止模拟';
            btn.className = "w-full bg-red-800 hover:bg-red-700 text-white py-3 rounded-lg font-bold text-lg shadow-lg transition";

            if (isReadyPhase) {
                isSimulating = true;
                isReadyPhase = false;
                startTime = Date.now();
            } else {
                if (!activeEnemyFleetId && !cachedEnemyConfig) {
                    cachedEnemyConfig = [
                        { count: 40, hp: 120, dmg: 12, speed: 3.5, agility: 0.1, range: 180, shape: 'square', color: '#ef4444' },
                        { count: 60, hp: 40, dmg: 8, speed: 6, agility: 0.3, range: 100, shape: 'triangle', color: '#f87171' }
                    ];
                    activeEnemyName = "AI 训练靶机";
                    activeEnemyFleetId = null;
                }
                setupScene(cachedEnemyConfig);
                isSimulating = true;
                startTime = Date.now();
            }
            document.getElementById('result-modal').classList.add('hidden');
        }

        function drawHpPanel(blues, reds) {
            hpCtx.clearRect(0, 0, hpCanvas.width, hpCanvas.height);
            
            const drawUnit = (unit, x, width, color) => {
                const height = hpCanvas.height * (unit.hp / unit.maxHp);
                const y = (hpCanvas.height - height) / 2;
                hpCtx.fillStyle = color;
                hpCtx.globalAlpha = 0.6 + (unit.hp / unit.maxHp) * 0.4;
                hpCtx.fillRect(x, y, width, height);
            };

            const blueWidth = (hpCanvas.width / 2) / Math.max(blues.length, 1);
            blues.forEach((d, i) => {
                const x = (hpCanvas.width / 2) - (i + 1) * blueWidth;
                drawUnit(d, x, blueWidth - 0.5, '#3b82f6');
            });

            const redWidth = (hpCanvas.width / 2) / Math.max(reds.length, 1);
            reds.forEach((d, i) => {
                const x = (hpCanvas.width / 2) + i * redWidth;
                drawUnit(d, x, redWidth - 0.5, '#ef4444');
            });
            hpCtx.globalAlpha = 1.0;
        }

        function loop() {
            ctx.fillStyle = '#050b14';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const minX = -1000;
            const maxX = WORLD_WIDTH - canvas.width + 1000;
            const minY = -1000;
            const maxY = WORLD_HEIGHT - canvas.height + 1000;
            camera.x = Math.max(minX, Math.min(camera.x, maxX));
            camera.y = Math.max(minY, Math.min(camera.y, maxY));

            ctx.save();
            ctx.translate(-camera.x, -camera.y);
            ctx.scale(camera.zoom, camera.zoom); 
            
            ctx.strokeStyle = '#1e293b';
            ctx.lineWidth = 4;
            ctx.strokeRect(0, 0, WORLD_WIDTH, WORLD_HEIGHT);
            
            ctx.fillStyle = '#0f172a';
            ctx.font = 'bold 300px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText("WARZONE", WORLD_WIDTH/2, WORLD_HEIGHT/2);

            if (isSimulating) {
                spatialGrid.clear();
                drones.forEach(d => spatialGrid.add(d));
            }

            let blues = [], reds = [];
            drones.forEach(d => {
                if (d.team === 'blue') blues.push(d); else reds.push(d);
            });

            drones.forEach(d => {
                if (isSimulating) {
                    let enemies = d.team === 'blue' ? reds : blues;
                    let friends = d.team === 'blue' ? blues : reds;
                    d.flock(friends, enemies, spatialGrid);
                    d.update();
                }
                d.draw(ctx);
            });

            drawHpPanel(blues, reds);

            for (let i = bullets.length - 1; i >= 0; i--) {
                let b = bullets[i];
                if(isSimulating) b.update();
                b.draw(ctx);
                
                if (!isSimulating) continue;
                if (b.life <= 0) { bullets.splice(i, 1); continue; }
                
                let potentialTargets = b.team === 'red' ? blues : reds;
                for (let t of potentialTargets) {
                    if (Vector.dist(b.pos, t.pos) < t.radius + 8) {
                        t.hp -= b.damage;
                        particles.push(new Particle(t.pos.x, t.pos.y, b.color, 15, 2));
                        bullets.splice(i, 1);
                        break;
                    }
                }
            }

            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i];
                if(isSimulating) p.update();
                p.draw(ctx);
                if(p.life <=0) particles.splice(i, 1);
            }

            ctx.restore();

            if (isSimulating) {
                for (let i = drones.length - 1; i >= 0; i--) {
                    if (drones[i].hp <= 0) {
                        let d = drones[i];
                        for(let k=0; k<6; k++) particles.push(new Particle(d.pos.x, d.pos.y, d.team==='red'?'#f87171':'#60a5fa', 30, 4));
                        drones.splice(i, 1);
                    }
                }

                document.getElementById('hud-player-count').innerText = blues.length;
                document.getElementById('hud-enemy-count').innerText = reds.length;

                if ((blues.length === 0 || reds.length === 0) && drones.length > 0) {
                    if (blues.length + reds.length < 5) return; 
                    endGame(blues.length > 0);
                }
            }

            animationId = requestAnimationFrame(loop);
        }

        async function endGame(playerWin) {
            isSimulating = false;
            const modal = document.getElementById('result-modal');
            modal.classList.remove('hidden');
            
            const duration = ((Date.now() - startTime) / 1000).toFixed(1);
            document.getElementById('result-time').innerText = duration + 's';
            document.getElementById('result-survivors').innerText = playerWin ? 
                document.getElementById('hud-player-count').innerText : 
                document.getElementById('hud-enemy-count').innerText;
            document.getElementById('result-enemy-name').innerText = activeEnemyName;

            const title = document.getElementById('result-title');
            if (playerWin) {
                title.innerText = "VICTORY";
                title.className = "text-5xl font-black mb-2 text-blue-500 drop-shadow-[0_0_15px_rgba(59,130,246,0.8)]";
                if (activeEnemyFleetId) await uploadBattleResult(true);
            } else {
                title.innerText = "DEFEAT";
                title.className = "text-5xl font-black mb-2 text-red-600 drop-shadow-[0_0_15px_rgba(220,38,38,0.8)]";
                if (activeEnemyFleetId) await uploadBattleResult(false);
            }
            
            const btn = document.getElementById('btn-start-sim');
            btn.innerHTML = '<i class="fas fa-play mr-2"></i> 重新开始';
            btn.className = "w-full bg-green-600 hover:bg-green-500 text-white py-3 rounded-lg font-bold text-lg shadow-lg shadow-green-900/50 transition";
        }
        
        async function uploadBattleResult(isPlayerWin) {
            try {
                // isPlayerWin = true (我方胜) -> 敌方败 -> increment_wins = false
                const { data, error } = await supabaseClient
                    .rpc('increment_stats', { 
                        row_id: activeEnemyFleetId, 
                        is_win: !isPlayerWin 
                    });
                
                if (error) throw error;
                console.log("Stats updated successfully via RPC");
            } catch (err) {
                console.warn("Stats Upload Failed:", err.message);
            }
        }
        
        function closeResult() {
            document.getElementById('result-modal').classList.add('hidden');
            activeEnemyFleetId = null; 
            cachedEnemyConfig = null; 
            setupScene(null);
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            hpCanvas.width = document.getElementById('hp-panel').clientWidth;
            hpCanvas.height = document.getElementById('hp-panel').clientHeight - 20; 
            
            if(!isSimulating && !isReadyPhase) {
                camera.x = WORLD_WIDTH/2 - canvas.width/2;
                camera.y = WORLD_HEIGHT/2 - canvas.height/2;
            }
        }
        window.addEventListener('resize', resize);

        canvas.addEventListener('mousedown', e => { isDragging = true; lastMousePos = { x: e.clientX, y: e.clientY }; });
        window.addEventListener('mouseup', () => isDragging = false);
        window.addEventListener('mousemove', e => {
            if (isDragging) {
                let dx = e.clientX - lastMousePos.x;
                let dy = e.clientY - lastMousePos.y;
                
                // 修复：限制拖拽时的缩放因子，防止缩小后速度过快
                // 当 zoom < 0.5 时，我们按 0.5 计算移动量，防止分母过小导致 dx 激增
                const dragScale = Math.max(camera.zoom, 0.5);
                
                camera.x -= dx / dragScale;
                camera.y -= dy / dragScale;
                lastMousePos = { x: e.clientX, y: e.clientY };
            }
        });

        canvas.addEventListener('wheel', e => {
            e.preventDefault();
            const zoomSensitivity = 0.001;
            const delta = -e.deltaY * zoomSensitivity;
            const oldZoom = camera.zoom;
            let newZoom = oldZoom + delta;
            newZoom = Math.max(0.2, Math.min(newZoom, 1.5));
            
            const mouseWorldX = (e.clientX + camera.x * oldZoom) / oldZoom;
            const mouseWorldY = (e.clientY + camera.y * oldZoom) / oldZoom;
            
            camera.zoom = newZoom;
            camera.x += (e.clientX / oldZoom) - (e.clientX / newZoom);
            camera.y += (e.clientY / oldZoom) - (e.clientY / newZoom);
        }, {passive: false});

        resize();
        renderSquadList();
        loop();
    </script>
</body>
</html>
